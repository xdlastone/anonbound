-- [[ CONFIGURATION ]] 
local TOGGLE_KEY      = Enum.KeyCode.RightControl

-- Настройки атмосферы (Night / Dim Mode)
local C_FOG           = Color3.fromHex("#131318") -- Очень темный, почти черный цвет тумана
local C_AMBIENT       = Color3.fromHex("#2a2a30") -- Тусклый цвет теней (чтобы не было черных дыр, но было темно)
local C_OUTDOOR       = Color3.fromHex("#1a1a20") -- Цвет внешнего освещения

local FOG_END         = 250   -- Дальность прорисовки (чем меньше, тем гуще туман)
local FOG_START       = 0     -- Начало тумана
local BRIGHTNESS      = 0     -- Яркость солнца (0 для мрачности)
local CLOCK_TIME      = 0     -- Время (00:00 - полночь)

-- Services
local RunService = game:GetService("RunService")
local Lighting = game:GetService("Lighting")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService") -- Опционально, если захочешь плавность

-- State
local enabled = false
local connection = nil

-- Хранилище оригинальных настроек
local originalSettings = {
    FogColor = Lighting.FogColor,
    FogStart = Lighting.FogStart,
    FogEnd = Lighting.FogEnd,
    Ambient = Lighting.Ambient,
    OutdoorAmbient = Lighting.OutdoorAmbient,
    Brightness = Lighting.Brightness,
    ClockTime = Lighting.ClockTime,
    GlobalShadows = Lighting.GlobalShadows
}

-- [[ LOGIC ]]

local function SaveOriginalSettings()
    -- Сохраняем текущие настройки игры, если мы еще не включили режим
    if not enabled then
        originalSettings.FogColor = Lighting.FogColor
        originalSettings.FogStart = Lighting.FogStart
        originalSettings.FogEnd = Lighting.FogEnd
        originalSettings.Ambient = Lighting.Ambient
        originalSettings.OutdoorAmbient = Lighting.OutdoorAmbient
        originalSettings.Brightness = Lighting.Brightness
        originalSettings.ClockTime = Lighting.ClockTime
        originalSettings.GlobalShadows = Lighting.GlobalShadows
    end
end

local function RestoreSettings()
    Lighting.FogColor = originalSettings.FogColor
    Lighting.FogStart = originalSettings.FogStart
    Lighting.FogEnd = originalSettings.FogEnd
    Lighting.Ambient = originalSettings.Ambient
    Lighting.OutdoorAmbient = originalSettings.OutdoorAmbient
    Lighting.Brightness = originalSettings.Brightness
    Lighting.ClockTime = originalSettings.ClockTime
    Lighting.GlobalShadows = originalSettings.GlobalShadows
end

local function EnableNightFog()
    -- Если в игре есть объект Atmosphere, он может мешать туману. 
    -- Мы его временно выключаем или делаем прозрачным, если нужно жесткое управление.
    for _, child in pairs(Lighting:GetChildren()) do
        if child:IsA("Atmosphere") then
            -- Можно либо удалить, либо отключить. Для сохранности просто не трогаем,
            -- но знай: Atmosphere перекрывает FogColor.
            -- child.Parent = nil -- (раскомментируй, если туман не того цвета)
        end
    end

    Lighting.FogColor = C_FOG
    Lighting.FogStart = FOG_START
    Lighting.FogEnd = FOG_END
    Lighting.Ambient = C_AMBIENT
    Lighting.OutdoorAmbient = C_OUTDOOR
    Lighting.Brightness = BRIGHTNESS
    Lighting.ClockTime = CLOCK_TIME
    Lighting.GlobalShadows = true
end

-- Основной цикл (Loop)
-- Используем RenderStepped, чтобы настройки не сбрасывались игровыми скриптами
connection = RunService.RenderStepped:Connect(function()
    if enabled then
        -- Постоянно форсируем наши настройки, чтобы игра не вернула день
        if Lighting.FogEnd ~= FOG_END or Lighting.ClockTime ~= CLOCK_TIME then
            EnableNightFog()
        end
    end
end)

-- Обработка нажатия клавиши
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if not gameProcessed and input.KeyCode == TOGGLE_KEY then
        enabled = not enabled
        
        if enabled then
            SaveOriginalSettings()
            EnableNightFog()
            print("[SCRIPT] Night Fog Enabled")
        else
            RestoreSettings()
            print("[SCRIPT] Night Fog Disabled")
        end
    end
end)

-- [[ CLEANUP ]]
-- Возвращает функцию для чистого удаления скрипта (например, если перезапускаешь его через executor)
return function()
    if connection then connection:Disconnect() end
    RestoreSettings()
end
