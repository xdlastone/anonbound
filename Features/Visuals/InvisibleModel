local Players = game:GetService("Players")
local connections = {}

-- [[ 1. ФУНКЦИИ ЛОГИКИ ]] --

local function setTransparency(part)
    if part:IsA("BasePart") then
        -- HumanoidRootPart всегда скрываем полностью
        if part.Name == "HumanoidRootPart" then
            part.Transparency = 1
        -- Остальные части делаем полупрозрачными
        else
            part.Transparency = 0.5
        end
    end
end

local function onCharacter(character)
    if not character then return end
    
    -- Меняем прозрачность у существующих частей
    for _, part in pairs(character:GetDescendants()) do
        setTransparency(part)
    end

    -- Следим за новыми частями (аксессуары/броня)
    local conn = character.DescendantAdded:Connect(function(descendant)
        task.wait() -- Ждем применения дефолтных настроек роблокса
        setTransparency(descendant)
    end)
    table.insert(connections, conn)
end

-- [[ 2. ЗАПУСК (ВКЛЮЧЕНИЕ) ]] --

-- Проходимся по всем игрокам, которые уже есть
for _, player in pairs(Players:GetPlayers()) do
    if player.Character then
        onCharacter(player.Character)
    end
    -- Подписываемся на их респавн
    local conn = player.CharacterAdded:Connect(onCharacter)
    table.insert(connections, conn)
end

-- Подписываемся на вход новых игроков
local addedConn = Players.PlayerAdded:Connect(function(player)
    local conn = player.CharacterAdded:Connect(onCharacter)
    table.insert(connections, conn)
end)
table.insert(connections, addedConn)

-- [[ 3. ВОЗВРАТ ФУНКЦИИ ОЧИСТКИ (ВЫКЛЮЧЕНИЕ) ]] --

return function()
    -- Отключаем все события (чтобы новые игроки/части не становились прозрачными)
    for _, conn in pairs(connections) do
        if conn then conn:Disconnect() end
    end
    
    -- Возвращаем видимость как было
    for _, player in pairs(Players:GetPlayers()) do
        if player.Character then
            for _, part in pairs(player.Character:GetDescendants()) do
                if part:IsA("BasePart") then
                    if part.Name == "HumanoidRootPart" then
                        part.Transparency = 1
                    else
                        part.Transparency = 0 -- Возвращаем полную видимость
                    end
                end
            end
        end
    end
end
